<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách sản phẩm</title>
    <link href="../styles/style.css" rel="stylesheet" type="text/css">
    <link href="../styles/product-list.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div class="container">
        <div class="page-navigation">
            <a href="/" class="back-button">
                Quay lại trang chủ
            </a>
        </div>

        <div class="product-list-header">
            <div class="header-top">
                <h1>Danh sách sản phẩm</h1>
                <div class="header-top-right">
                    <span class="product-count" id="productCount"></span>
                    <div class="add-product-dropdown">
                        <button class="add-product-btn">
                            Thêm sản phẩm ▼
                        </button>
                        <div class="add-product-dropdown-content">
                            <a href="/add/product">Nhập thông tin sản phẩm</a>
                            <a href="#" id="importJsonBtn">Nhập file JSON</a>
                            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Tìm kiếm sản phẩm..."
                >
                <div class="action-buttons">
                        <button id="searchButton" class="search-button">
                            Tìm kiếm
                        </button>
                        <button id="updateSelectedButton" class="update-selected-button" disabled>
                            Cập nhật sản phẩm
                        </button>
                        <button id="deleteSelectedButton" class="delete-selected-button" disabled>
                            Xóa sản phẩm
                        </button>
                    </div>
                </div>
            </div>

        <div class="main-container">
            <div class="filter-sidebar">
                <div class="filter-section">
                    <div class="filter-header" id="sortFilterHeader">
                        <h3>Sắp xếp</h3>
                    </div>
                    <div class="filter-content" id="sortFilterContent">
                        <div class="sort-filter">
                            <select id="sortFieldFilter" class="sort-select">
                                <option value="title">Tên</option>
                                <option value="productId">ID</option>
                                <option value="price">Giá</option>
                                <option value="rating">Đánh giá</option>
                            </select>
                            <select id="sortDirectionFilter" class="sort-select">
                                <option value="asc">Tăng dần</option>
                                <option value="desc">Giảm dần</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('categoryFilter')">
                        <h3>Danh mục</h3>
                        <span class="toggle-icon" id="categoryFilterIcon">▼</span>
                    </div>
                    <div class="filter-content collapsed" id="categoryFilterContent">
                        <div id="categoryFilterContainer" class="checkbox-filter-container">
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('originFilter')">
                        <h3>Xuất xứ</h3>
                        <span class="toggle-icon" id="originFilterIcon">▼</span>
                    </div>
                    <div class="filter-content collapsed" id="originFilterContent">
                        <div id="originFilterContainer" class="checkbox-filter-container">
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-header" onclick="toggleFilterSection('priceFilter')">
                        <h3>Khoảng giá</h3>
                        <span class="toggle-icon" id="priceFilterIcon">▼</span>
                    </div>
                    <div class="filter-content" id="priceFilterContent">
                        <div class="price-range-filter">
                            <button id="togglePriceMode" class="toggle-price-mode">Nhập giá thủ công</button>
                            <div id="priceRangeContainer" class="checkbox-filter-container">
                                <div>
                                    <input type="checkbox" id="price-range-1" name="priceRange" value="0-100000">
                                    <label for="price-range-1">Dưới 100.000 VND</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="price-range-2" name="priceRange" value="100000-300000">
                                    <label for="price-range-2">100.000 - 300.000 VND</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="price-range-3" name="priceRange" value="300000-500000">
                                    <label for="price-range-3">300.000 - 500.000 VND</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="price-range-4" name="priceRange" value="500000-1000000">
                                    <label for="price-range-4">500.000 - 1.000.000 VND</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="price-range-5" name="priceRange" value="1000000-">
                                    <label for="price-range-5">Trên 1.000.000 VND</label>
                                </div>
                            </div>
                            <div id="customPriceContainer" class="price-input-container hidden">
                                <div class="price-row">
                                    <p>Từ:</p>
                                    <input type="number" id="customMinPrice" class="price-input" placeholder="0" step="10000" min="0">
                                    <span>VND</span>
                                </div>
                                <div class="price-row">
                                    <p>Đến:</p>
                                    <input type="number" id="customMaxPrice" class="price-input" placeholder="0" step="10000" min="0">
                                    <span>VND</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main content area -->
            <div class="main-content">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="checkbox-column">
                                    <input type="checkbox" id="selectAll" class="select-all-checkbox" onclick="toggleSelectAll()">
                                </th>
                                <th>ID</th>
                                <th>Tên sản phẩm</th>
                                <th>Danh mục</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thương hiệu</th>
                                <th>Xuất xứ</th>
                                <th>Đánh giá</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Pagination controls -->
                <div class="pagination-container">
                    <ul class="pagination" id="pagination">
                        <!-- Pagination buttons will be generated here -->
                    </ul>
                </div>
                <div class="pagination-info" id="paginationInfo"></div>
            </div>
        </div>
    </div>

    <div id="deleteConfirmation" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Xác nhận xóa</h3>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmationMessage"></p>
            </div>
            <div class="modal-buttons">
                <button class="cancel-button" id="cancelDelete">Hủy</button>
                <button class="confirm-button confirm-delete" id="confirmDelete">Xóa</button>
            </div>
        </div>
    </div>

    <div id="updateSelectedProductsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cập nhật các sản phẩm đã chọn</h3>
            </div>
            <div class="modal-body" id="updateProductsList">
                <!-- Product update forms will be dynamically added here -->
            </div>
            <div class="modal-buttons">
                <button class="cancel-button" id="cancelUpdateModal">Đóng</button>
                <button class="confirm-button" id="updateAllProductsButton">Cập nhật sản phẩm</button>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];
        let categories = new Set();
        let origins = new Set();
        let currentPage = 1;
        const productsPerPage = 10;
        let filteredProducts = [];

        // Sự kiện lắng nghe khi DOM đã tải xong hoàn toàn
        document.addEventListener('DOMContentLoaded', () => {
            // Tải dữ liệu sản phẩm và danh mục
            loadProductsData();
            
            // Thiết lập các sự kiện ban đầu
            document.getElementById('searchButton').addEventListener('click', SearchProducts);
            document.getElementById('updateSelectedButton').addEventListener('click', showUpdateSelectedProductsModal);
            document.getElementById('deleteSelectedButton').addEventListener('click', showDeleteManyConfirmation);
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    SearchProducts();
                }
            });
            
            // Thiết lập các sự kiện chuyển đổi phần lọc
            setupFilterToggleEvents();
            
            // Thiết lập các sự kiện đóng modal
            setupModalEvents();

            // Thiết lập sự kiện nhập file JSON
            setupJsonImportEvents();
        });

        const setupFilterToggleEvents = () => {
            const filterHeaders = document.querySelectorAll('.filter-header');
            filterHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const sectionId = header.id.replace('Header', '');
                    toggleFilterSection(sectionId);
                });
            });
            
            // Thiết lập nút chuyển đổi chế độ giá
            const togglePriceModeButton = document.getElementById('togglePriceMode');
            if (togglePriceModeButton) {
                togglePriceModeButton.addEventListener('click', () => {
                    const priceRangeContainer = document.getElementById('priceRangeContainer');
                    const customPriceContainer = document.getElementById('customPriceContainer');
                    const isCustomPriceActive = customPriceContainer.classList.contains('hidden');

                    if (isCustomPriceActive) {
                        // Chuyển sang chế độ giá tùy chỉnh
                        customPriceContainer.classList.remove('hidden');
                        priceRangeContainer.classList.add('hidden');
                        document.querySelectorAll('#priceRangeContainer input[type="checkbox"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        togglePriceModeButton.textContent = 'Chọn khoảng giá';
                    } else {
                        // Chuyển sang chế độ giá checkbox
                        customPriceContainer.classList.add('hidden');
                        priceRangeContainer.classList.remove('hidden');
                        document.getElementById('customMinPrice').value = '';
                        document.getElementById('customMaxPrice').value = '';
                        togglePriceModeButton.textContent = 'Nhập giá thủ công';
                    }

                    SearchProducts();
                });
            }
        }

        const setupModalEvents = () => {
            // Modal xác nhận xóa
            document.getElementById('cancelDelete').addEventListener('click', () => {
                document.getElementById('deleteConfirmation').classList.add('hidden');
            });
            
            // Modal cập nhật
            document.getElementById('cancelUpdateModal').addEventListener('click', () => {
                document.getElementById('updateSelectedProductsModal').classList.add('hidden');
            });
        }

        const setupJsonImportEvents = () => {
            const importJsonBtn = document.getElementById('importJsonBtn');
            const jsonFileInput = document.getElementById('jsonFileInput');
            
            importJsonBtn.addEventListener('click', (e) => {
                e.preventDefault();
                jsonFileInput.value = '';
                jsonFileInput.click();
            });
            
            jsonFileInput.addEventListener('change', handleJsonFileSelection);
        };

        const readAndSendJsonFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async (event) => {
                    try {
                        const jsonContent = event.target.result;
                        
                        // Parse để kiểm tra JSON hợp lệ trước khi gửi
                        const parsedJson = JSON.parse(jsonContent);
                        
                        // Gửi nội dung JSON đến server
                        const response = await fetch('/import/products/json', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: jsonContent
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Hiển thị thông báo thành công với chi tiết
                            alert(result.message);
                            loadProductsData(); // Tải lại danh sách sản phẩm
                            resolve(result);
                        } else {
                            // Hiển thị thông báo lỗi từ server
                            alert(result.error);
                            reject(new Error(result.error));
                        }
                    } catch (parseError) {
                        // Lỗi phân tích JSON
                        alert('File JSON không đúng định dạng. Vui lòng kiểm tra và thử lại.');
                        console.error('Lỗi phân tích JSON:', parseError);
                        reject(parseError);
                    }
                };
                
                reader.onerror = () => {
                    alert('Không thể đọc file.');
                    reject(new Error('File reading error'));
                };
                
                reader.readAsText(file);
            });
        };

        const handleJsonFileSelection = async (e) => {
            const file = e.target.files[0];
            const importJsonBtn = document.getElementById('importJsonBtn');
            const jsonFileInput = document.getElementById('jsonFileInput');

            if (!file) {
                alert('Vui lòng chọn một tệp JSON để nhập!');
                return;
            }
            
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert('Vui lòng chọn file có định dạng JSON!');
                jsonFileInput.value = '';
                return;
            }
            
            try {
                importJsonBtn.disabled = true;
                importJsonBtn.textContent = 'Đang nhập...';
                
                // Đọc file và gửi đến server
                await readAndSendJsonFile(file);
                
            } catch (error) {
                console.error('Lỗi khi nhập dữ liệu JSON:', error);
            } finally {
                importJsonBtn.disabled = false;
                importJsonBtn.textContent = 'Nhập file JSON';
                jsonFileInput.value = '';
            }
        };

        // Tải dữ liệu sản phẩm từ server
        const loadProductsData = () => {
            fetch('/products')
                .then(res => res.json())
                .then(products => {
                    allProducts = products;
                    filteredProducts = products;
                    
                    // Trích xuất danh mục và xuất xứ
                    extractCategoriesAndOrigins(products);
                    
                    // Hiển thị sản phẩm trên trang đầu tiên
                    displayProductsByPage(currentPage);
                    
                    // Thiết lập tất cả các sự kiện lọc sau khi dữ liệu được tải
                    setupFilterEventListeners();
                })
                .catch(error => {
                    console.error('Lỗi khi lấy dữ liệu sản phẩm:', error);
                    alert('Không thể tải dữ liệu sản phẩm');
                });
        }

        const extractCategoriesAndOrigins = (products) => {
            categories = new Set();
            origins = new Set();

            products.forEach(product => {
                if (product.category) {
                    categories.add(product.category);
                }

                if (product.additionalInfo && product.additionalInfo.origin) {
                    origins.add(product.additionalInfo.origin);
                }
            });

            // Điền các checkbox danh mục
            populateCategoryCheckboxes();
            
            // Điền các checkbox xuất xứ
            populateOriginCheckboxes();
        }

        const populateCategoryCheckboxes = () => {
            const categoryContainer = document.getElementById('categoryFilterContainer');
            if (categoryContainer) {
                categoryContainer.innerHTML = '';
                Array.from(categories).sort().forEach((category, index) => {
                    const div = document.createElement('div');
                    const checkboxId = `cat-check-${index}`;
                    div.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${category}" name="categoryFilter">
                        <label for="${checkboxId}">${category}</label>
                    `;
                    categoryContainer.appendChild(div);
                });
            }
        }

        const populateOriginCheckboxes = () => {
            const originContainer = document.getElementById('originFilterContainer');
            if (originContainer) {
                originContainer.innerHTML = '';
                Array.from(origins).sort().forEach((origin, index) => {
                    const div = document.createElement('div');
                    const checkboxId = `org-check-${index}`;
                    div.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${origin}" name="originFilter">
                        <label for="${checkboxId}">${origin}</label>
                    `;
                    originContainer.appendChild(div);
                });
            }
        }

        const SearchProducts = () => {
            const filters = getFilterValues();
            applyFilters(filters);
            applySort();
            currentPage = 1;
            displayProductsByPage(currentPage);
        }

        const getFilterValues = () => {
            return {
                keyword: document.getElementById('searchInput').value.trim(),
                categories: Array.from(document.querySelectorAll('#categoryFilterContainer input[name="categoryFilter"]:checked'))
                               .map(checkbox => checkbox.value),
                origins: Array.from(document.querySelectorAll('#originFilterContainer input[name="originFilter"]:checked'))
                              .map(checkbox => checkbox.value),
                priceRanges: Array.from(document.querySelectorAll('#priceRangeContainer input[name="priceRange"]:checked'))
                                 .map(checkbox => checkbox.value),
                customMinPrice: parseCustomPrice('customMinPrice'),
                customMaxPrice: parseCustomPrice('customMaxPrice')
            };
        }

        const parseCustomPrice = (elementId) => {
            const value = document.getElementById(elementId).value;
            return value ? Math.max(0, Number(value)) : null;
        }

        const applyFilters = (filters) => {
            // Bắt đầu lọc từ toàn bộ danh sách sản phẩm
            filteredProducts = [...allProducts];
            
            // Điều chỉnh giá trị min/max nếu cần
            if (filters.customMinPrice !== null && filters.customMaxPrice !== null) {
                if (filters.customMinPrice > filters.customMaxPrice) {
                    document.getElementById('customMaxPrice').value = filters.customMinPrice;
                    filters.customMaxPrice = filters.customMinPrice;
                } else if (filters.customMaxPrice < filters.customMinPrice) {
                    document.getElementById('customMinPrice').value = filters.customMaxPrice;
                    filters.customMinPrice = filters.customMaxPrice;
                }
            }

            // Áp dụng lọc từ khóa
            if (filters.keyword) {
                filteredProducts = filteredProducts.filter(product =>
                    product.productId.toLowerCase().includes(filters.keyword.toLowerCase()) ||
                    product.title.toLowerCase().includes(filters.keyword.toLowerCase()) ||
                    (product?.additionalInfo?.brand || '').toLowerCase().includes(filters.keyword.toLowerCase()) ||
                    (product?.additionalInfo?.origin || '').toLowerCase().includes(filters.keyword.toLowerCase())
                );
            }

            // Áp dụng lọc danh mục
            if (filters.categories.length > 0) {
                filteredProducts = filteredProducts.filter(product =>
                    product.category && filters.categories.includes(product.category)
                );
            }

            // Áp dụng lọc xuất xứ
            if (filters.origins.length > 0) {
                filteredProducts = filteredProducts.filter(product =>
                    product.additionalInfo?.origin && filters.origins.includes(product.additionalInfo.origin)
                );
            }

            // Áp dụng lọc khoảng giá
            if (filters.priceRanges.length > 0) {
                filteredProducts = filteredProducts.filter(product => {
                    const price = product.additionalInfo?.price || 0;
                    return filters.priceRanges.some(range => {
                        const [min, max] = range.split('-').map(Number);
                        return (min === undefined || price >= min) && (max === undefined || price <= max);
                    });
                });
            }

            // Áp dụng lọc giá tùy chỉnh
            if (filters.customMinPrice !== null) {
                filteredProducts = filteredProducts.filter(product =>
                    product.additionalInfo?.price >= filters.customMinPrice
                );
            }

            if (filters.customMaxPrice !== null) {
                filteredProducts = filteredProducts.filter(product =>
                    product.additionalInfo?.price <= filters.customMaxPrice
                );
            }
        }

        const applySort = () => {
            const sortField = document.getElementById('sortFieldFilter').value;
            const sortDirection = document.getElementById('sortDirectionFilter').value;

            filteredProducts = [...filteredProducts];

            filteredProducts.sort((a, b) => {
                let valueA, valueB;

                if (sortField === 'price') {
                    valueA = a.additionalInfo?.price || 0;
                    valueB = b.additionalInfo?.price || 0;
                } else if (sortField === 'rating') {
                    valueA = a.rating || 0;
                    valueB = b.rating || 0;
                } else if (sortField === 'productId') {
                    valueA = a.productId || '';
                    valueB = b.productId || '';
                } else {
                    valueA = a.title || '';
                    valueB = b.title || '';
                }

                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    if (sortDirection === 'asc') {
                        return valueA.localeCompare(valueB);
                    } else {
                        return valueB.localeCompare(valueA);
                    }
                }

                if (sortDirection === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });

            currentPage = 1;
            displayProductsByPage(currentPage);
        }

        const setupFilterEventListeners = () => {
            // Sự kiện lọc danh mục
            document.querySelectorAll('#categoryFilterContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', SearchProducts);
            });

            // Sự kiện lọc xuất xứ
            document.querySelectorAll('#originFilterContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', SearchProducts);
            });

            // Sự kiện lọc khoảng giá
            document.querySelectorAll('#priceRangeContainer input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', SearchProducts);
            });

            // Sự kiện nhập giá tùy chỉnh
            document.getElementById('customMinPrice').addEventListener('input', () => {
                let customMinPrice = document.getElementById('customMinPrice').value ? Math.max(0, Number(document.getElementById('customMinPrice').value)) : null;
                let customMaxPriceInput = document.getElementById('customMaxPrice');
                let customMaxPrice = customMaxPriceInput.value ? Math.max(0, Number(customMaxPriceInput.value)) : null;

                if (customMaxPrice !== null && customMinPrice !== null && customMinPrice > customMaxPrice) {
                    customMaxPriceInput.value = customMinPrice;
                }

                SearchProducts();
            });

            document.getElementById('customMaxPrice').addEventListener('input', () => {
                let customMaxPrice = document.getElementById('customMaxPrice').value ? Math.max(0, Number(document.getElementById('customMaxPrice').value)) : null;
                let customMinPriceInput = document.getElementById('customMinPrice');
                let customMinPrice = customMinPriceInput.value ? Math.max(0, Number(customMinPriceInput.value)) : null;

                if (customMaxPrice !== null && customMinPrice !== null && customMaxPrice < customMinPrice) {
                    document.getElementById('customMaxPrice').value = customMinPrice;
                }

                SearchProducts();
            });

            // Sự kiện lọc sắp xếp
            document.getElementById('sortFieldFilter').addEventListener('change', applySort);
            document.getElementById('sortDirectionFilter').addEventListener('change', applySort);
            
            // Checkbox chọn tất cả
            document.getElementById('selectAll').addEventListener('click', toggleSelectAll);
        }

        const toggleFilterSection = (sectionId) => {
            const content = document.getElementById(`${sectionId}Content`);
            const icon = document.getElementById(`${sectionId}Icon`);

            if (content) {
                content.classList.toggle('collapsed');
            }
            
            if (icon) {
                icon.classList.toggle('collapsed');
            }
        }

        const toggleSelectAll = () => {
            const selectAllCheckbox = document.getElementById('selectAll');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateActionButtonsState();
        }

        const updateActionButtonsState = () => {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            const deleteSelectedButton = document.getElementById('deleteSelectedButton');
            const updateSelectedButton = document.getElementById('updateSelectedButton');
            const isDisabled = selectedCheckboxes.length === 0;
            deleteSelectedButton.disabled = isDisabled;
            updateSelectedButton.disabled = isDisabled;
        }

        const displayProductsByPage = (page) => {
            const startIndex = (page - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;

            const currentProducts = filteredProducts.slice(startIndex, endIndex);

            displayProducts(currentProducts);
            updatePagination();

            const start = filteredProducts.length > 0 ? startIndex + 1 : 0;
            const end = Math.min(endIndex, filteredProducts.length);
            document.getElementById('paginationInfo').textContent = 
                `Hiển thị ${start} - ${end} của ${filteredProducts.length} sản phẩm`;
        }

        const updatePagination = () => {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            const prevButton = document.createElement('li');
            prevButton.innerHTML = `<span class="pagination-button ${currentPage === 1 ? 'disabled' : ''}">«</span>`;
            if (currentPage > 1) {
                prevButton.querySelector('.pagination-button').addEventListener('click', () => {
                    currentPage--;
                    displayProductsByPage(currentPage);
                });
            }
            paginationElement.appendChild(prevButton);

            // Hiển thị logic nút phân trang
            const maxVisibleButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisibleButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxVisibleButtons - 1);

            if (endPage - startPage < maxVisibleButtons - 1) {
                startPage = Math.max(1, endPage - maxVisibleButtons + 1);
            }

            if (startPage > 1) {
                const firstButton = document.createElement('li');
                firstButton.innerHTML = `<span class="pagination-button">1</span>`;
                firstButton.querySelector('.pagination-button').addEventListener('click', () => {
                    currentPage = 1;
                    displayProductsByPage(currentPage);
                });
                paginationElement.appendChild(firstButton);

                if (startPage > 2) {
                    const ellipsis = document.createElement('li');
                    ellipsis.innerHTML = `<span class="pagination-button">...</span>`;
                    paginationElement.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('li');
                pageButton.innerHTML = `<span class="pagination-button ${i === currentPage ? 'active' : ''}">${i}</span>`;

                if (i !== currentPage) {
                    pageButton.querySelector('.pagination-button').addEventListener('click', () => {
                        currentPage = i;
                        displayProductsByPage(currentPage);
                    });
                }

                paginationElement.appendChild(pageButton);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.innerHTML = `<span class="pagination-button">...</span>`;
                    paginationElement.appendChild(ellipsis);
                }

                const lastButton = document.createElement('li');
                lastButton.innerHTML = `<span class="pagination-button">${totalPages}</span>`;
                lastButton.querySelector('.pagination-button').addEventListener('click', () => {
                    currentPage = totalPages;
                    displayProductsByPage(currentPage);
                });
                paginationElement.appendChild(lastButton);
            }

            const nextButton = document.createElement('li');
            nextButton.innerHTML = `<span class="pagination-button ${currentPage === totalPages ? 'disabled' : ''}">»</span>`;
            if (currentPage < totalPages) {
                nextButton.querySelector('.pagination-button').addEventListener('click', () => {
                    currentPage++;
                    displayProductsByPage(currentPage);
                });
            }
            paginationElement.appendChild(nextButton);
        }

        const displayProducts = (products) => {
            let tableHTML = '';
            if (products.length === 0) {
                tableHTML = `
                    <tr>
                        <td colspan="10">Không tìm thấy sản phẩm nào</td>
                    </tr>
                `;
            } else {
                products.forEach(product => {
                    tableHTML += `
                        <tr class="row-clickable" data-product-id="${product.productId}">
                            <td class="checkbox-column" onclick="event.stopPropagation();">
                                <input type="checkbox" class="product-checkbox" data-product-id="${product.productId}" data-product-title="${product.title}">
                            </td>
                            <td>${product.productId}</td>
                            <td>${product.title}</td>
                            <td><span class="category-badge">${product.category || 'Chưa phân loại'}</span></td>
                            <td>${formatPrice(product.additionalInfo.price)}</td>
                            <td>${product.additionalInfo.quantity}</td>
                            <td>${product.additionalInfo.brand}</td>
                            <td>${product.additionalInfo.origin || ''}</td>
                            <td>${product.rating || 0}</td>
                            <td onclick="event.stopPropagation();">
                                <span class="action-icon edit-icon" title="Cập nhật" data-product-id="${product.productId}">✎</span>
                                <span class="action-icon delete-icon" title="Xóa" data-product-id="${product.productId}" data-product-title="${product.title}">✕</span>
                            </td>
                        </tr>
                    `;
                });
            }
            
            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = tableHTML;
            document.getElementById('productCount').textContent = `${filteredProducts.length} sản phẩm`;
            
            // Thêm các sự kiện lắng nghe cho các phần tử mới tạo
            attachProductRowEventListeners();
        }
        
        const attachProductRowEventListeners = () => {
            // Sự kiện click hàng
            document.querySelectorAll('.row-clickable').forEach(row => {
                row.addEventListener('click', () => {
                    const productId = row.dataset.productId;
                    showProductDetails(productId);
                });
            });
            
            // Sự kiện click biểu tượng chỉnh sửa
            document.querySelectorAll('.edit-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = icon.dataset.productId;
                    showUpdateProductForm(productId);
                });
            });
            
            // Sự kiện click biểu tượng xóa
            document.querySelectorAll('.delete-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const productId = icon.dataset.productId;
                    const productTitle = icon.dataset.productTitle;
                    showDeleteConfirmation(productId, productTitle);
                });
            });
            
            // Sự kiện thay đổi checkbox
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateActionButtonsState);
            });
        }

        const formatPrice = (price) => 
            (price == null || isNaN(price)) ? 0 : `${Number(price).toLocaleString()} VND`;

        const showProductDetails = (productId) => {
            window.location.href = `/productdetail?id=${productId}`;
        }

        const showDeleteConfirmation = (productId, productName) => {
            const modal = document.getElementById('deleteConfirmation');
            const message = document.getElementById('deleteConfirmationMessage');
            const confirmDeleteButton = document.getElementById('confirmDelete');
            const cancelDeleteButton = document.getElementById('cancelDelete');

            message.innerHTML = `Bạn có chắc chắn muốn xóa sản phẩm <strong>${productName}</strong>?`;
            modal.classList.remove('hidden');

            confirmDeleteButton.onclick = () => {
                deleteProduct(productId);
                modal.classList.add('hidden');
            };

            cancelDeleteButton.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        const showDeleteManyConfirmation = () => {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm để xóa!');
                return;
            }

            const productIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.productId);
            const productTitles = Array.from(selectedCheckboxes).map(cb => cb.dataset.productTitle);

            const modal = document.getElementById('deleteConfirmation');
            const message = document.getElementById('deleteConfirmationMessage');
            const confirmDeleteButton = document.getElementById('confirmDelete');
            const cancelDeleteButton = document.getElementById('cancelDelete');

            message.innerHTML = `Bạn có chắc chắn muốn xóa ${productIds.length} sản phẩm: <strong>${productTitles.join(', ')}</strong>?`;
            modal.classList.remove('hidden');

            confirmDeleteButton.onclick = () => {
                deleteManyProducts(productIds);
                modal.classList.add('hidden');
            };

            cancelDeleteButton.onclick = () => {
                modal.classList.add('hidden');
            };
        }

        const showUpdateSelectedProductsModal = async () => {
            const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm để cập nhật!');
                return;
            }

            const productIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.productId);
            const updateProductsList = document.getElementById('updateProductsList');
            updateProductsList.innerHTML = '<p>Đang tải dữ liệu sản phẩm...</p>';

            const modal = document.getElementById('updateSelectedProductsModal');
            modal.classList.remove('hidden');

            const cancelUpdateButton = document.getElementById('cancelUpdateModal');
            cancelUpdateButton.onclick = () => {
                modal.classList.add('hidden');
                updateProductsList.innerHTML = '';
            };

            const updateAllButton = document.getElementById('updateAllProductsButton');
            updateAllButton.onclick = async () => {
                const forms = document.querySelectorAll('.update-product-form');
                let allSuccessful = true;
                const errors = [];

                for (const form of forms) {
                    const productId = form.dataset.productId;
                    const formData = new FormData(form);

                    // Handle multiple file inputs
                    const fileInput = form.querySelector(`input[name="images"]`);
                    if (fileInput.files.length > 0) {
                        for (const file of fileInput.files) {
                            formData.append('images', file);
                        }
                    }

                    try {
                        const response = await fetch(`/update/product/${productId}`, {
                            method: 'PUT',
                            body: formData
                        });
                        const data = await response.json();
                        if (!data.success) {
                            allSuccessful = false;
                            errors.push(`Sản phẩm ${productId}: ${data.error || 'Không thể cập nhật'}`);
                        }
                    } catch (error) {
                        allSuccessful = false;
                        errors.push(`Sản phẩm ${productId}: Lỗi khi cập nhật - ${error.message}`);
                    }
                }

                if (allSuccessful) {
                    modal.classList.add('hidden');
                    alert('Cập nhật tất cả sản phẩm thành công!');
                    window.location.href = '/productlist';
                } else {
                    alert('Có lỗi xảy ra khi cập nhật một số sản phẩm:\n' + errors.join('\n'));
                }
            };

            try {
                let formsHTML = '';
                for (const productId of productIds) {
                    const response = await fetch(`/products/${productId}`);
                    if (!response.ok) {
                        throw new Error(`Không thể tải sản phẩm ${productId}`);
                    }
                    const product = await response.json();

                    formsHTML += `
                        <div class="product-update-section">
                            <h4>Sản phẩm: ${product.title} (ID: ${product.productId})</h4>
                            <form class="update-product-form" data-product-id="${product.productId}">
                                <div class="form-group">
                                    <label for="productId_${product.productId}">ID sản phẩm</label>
                                    <input type="text" id="productId_${product.productId}" name="productId" value="${product.productId}" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="title_${product.productId}">Tên sản phẩm</label>
                                    <input type="text" id="title_${product.productId}" name="title" value="${product.title}" required>
                                </div>
                                <div class="form-group">
                                    <label for="category_${product.productId}">Danh mục</label>
                                    <select id="category_${product.productId}" name="category">
                                        <option value="">Chọn danh mục</option>
                                        ${Array.from(categories).map(cat => `
                                            <option value="${cat}" ${cat === product.category ? 'selected' : ''}>${cat}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="price_${product.productId}">Giá</label>
                                    <input type="number" id="price_${product.productId}" name="price" value="${product.additionalInfo.price}" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="quantity_${product.productId}">Số lượng</label>
                                    <input type="number" id="quantity_${product.productId}" name="quantity" value="${product.additionalInfo.quantity}" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="brand_${product.productId}">Thương hiệu</label>
                                    <input type="text" id="brand_${product.productId}" name="brand" value="${product.additionalInfo.brand}" required>
                                </div>
                                <div class="form-group">
                                    <label for="origin_${product.productId}">Xuất xứ</label>
                                    <input type="text" id="origin_${product.productId}" name="origin" value="${product.additionalInfo.origin || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="rating_${product.productId}">Đánh giá</label>
                                    <input type="number" id="rating_${product.productId}" name="rating" value="${product.rating || 0}" step="0.1" min="0" max="5">
                                </div>
                                <div class="form-group">
                                    <label for="description_${product.productId}">Mô tả</label>
                                    <textarea id="description_${product.productId}" name="description">${product.description.details || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="images_${product.productId}">Hình ảnh</label>
                                    <input type="file" id="images_${product.productId}" name="images" accept="image/*" multiple>
                                    <small>Hiện tại: ${product.images.length} ảnh</small>
                                </div>
                            </form>
                        </div>
                    `;
                }

                updateProductsList.innerHTML = formsHTML;
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu sản phẩm:', error);
                updateProductsList.innerHTML = '<p>Không thể tải dữ liệu sản phẩm. Vui lòng thử lại.</p>';
            }
        }

        const deleteProduct = (productId) => {
            fetch(`/delete/product/${productId}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    fetch('/products')
                        .then(res => res.json())
                        .then(products => {
                            allProducts = products;
                            SearchProducts();
                            alert('Sản phẩm đã được xóa thành công!');
                        })
                        .catch(error => {
                            console.error('Lỗi khi làm mới danh sách sản phẩm:', error);
                            alert('Lỗi khi làm mới danh sách sản phẩm!');
                        });
                } else {
                    alert('Không thể xóa sản phẩm. Vui lòng thử lại sau!');
                }
            })
            .catch(error => {
                console.error('Lỗi khi xóa sản phẩm:', error);
                alert('Đã xảy ra lỗi khi xóa sản phẩm!');
            });
        }

        const deleteManyProducts = (productIds) => {
            fetch('/delete/products', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fetch('/products')
                        .then(res => res.json())
                        .then(products => {
                            allProducts = products;
                            displayProducts(products);
                            alert(data.message);
                        })
                        .catch(error => {
                            console.error('Lỗi khi làm mới danh sách sản phẩm:', error);
                            alert('Lỗi khi làm mới danh sách sản phẩm!');
                        });
                } else {
                    alert(data.error || 'Không thể xóa các sản phẩm. Vui lòng thử lại sau!');
                }
            })
            .catch(error => {
                console.error('Lỗi khi xóa nhiều sản phẩm:', error);
                alert('Đã xảy ra lỗi khi xóa các sản phẩm!');
            });
        }

        const showUpdateProductForm = (productId) => {
            fetch(`/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    if (product) {
                        const url = `/update/product?id=${encodeURIComponent(product.productId)}&title=${encodeURIComponent(product.title)}&brand=${encodeURIComponent(product.additionalInfo.brand)}&origin=${encodeURIComponent(product.additionalInfo.origin)}`;
                        window.location.href = url;
                    } else {
                        alert('Không tìm thấy sản phẩm!');
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi lấy thông tin sản phẩm:', error);
                    alert('Lỗi khi tải thông tin sản phẩm!');
                });
        }
    </script>
</body>
</html>