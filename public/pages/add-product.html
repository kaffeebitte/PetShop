<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm sản phẩm</title>
    <link href="../styles/style.css" rel="stylesheet" type="text/css">
    <link href="../styles/add-product.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="container">
        <form id="addProductForm" action="/products" method="POST" enctype="multipart/form-data" class="form-container">
            <div class="page-navigation">
                <a href="/" class="back-button">
                    Quay lại
                </a>
            </div>

            <h1 class="form-title">Thêm sản phẩm mới</h1>

            <div class="form-row">
                <div class="form-group">
                    <label for="productId" class="required-field">ID sản phẩm</label>
                    <input type="text" id="productId" name="productId" class="form-control" readonly required>
                </div>
                <div class="form-group">
                    <label for="title" class="required-field">Tên sản phẩm</label>
                    <input type="text" id="title" name="title" class="form-control" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="price" class="required-field">Giá</label>
                    <input type="number" id="price" name="price" class="form-control" min="0" step="1000" required>
                </div>
                <div class="form-group">
                    <label for="quantity" class="required-field">Số lượng</label>
                    <input type="number" id="quantity" name="quantity" class="form-control" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="brand" class="required-field">Thương hiệu</label>
                    <input type="text" id="brand" name="brand" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="origin" class="required-field">Xuất xứ</label>
                    <input type="text" id="origin" name="origin" class="form-control" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="rating">Đánh giá</label>
                    <input type="number" id="rating" name="rating" step="0.5" min="0" max="5" class="form-control">
                </div>
                <div class="form-group">
                    <label for="category" class="required-field">Danh mục</label>
                    <select id="category" name="category" class="form-control" required>
                        <option value="" disabled selected>Chọn danh mục</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description">Mô tả</label>
                <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="images">Hình ảnh</label>
                <input type="file" id="images" name="images" multiple class="form-control-file"
                    accept=".png, .jpg, .jpeg">
                <small class="text-light">Chỉ chấp nhận các định dạng: PNG, JPG, JPEG. Có thể chọn tối đa 10 file hình
                    ảnh</small>
                <div id="imagePreviewContainer" class="image-preview-container"></div>
            </div>

            <div class="form-buttons">
                <button type="submit" class="btn btn-primary">Thêm sản phẩm</button>
            </div>
        </form>
    </div>

    <script>
        const productIdInput = document.getElementById('productId');
        const imagesInput = document.getElementById('images');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const form = document.getElementById('addProductForm');
        let productIdList = [];
        let categoryList = ['Thức ăn', 'Phụ kiện', 'Đồ chơi', 'Vệ sinh', 'Quần áo', 'Chuồng', 'Vận chuyển'];
        let selectedFiles = new DataTransfer();
        
        const categoryPrefixes = {
            'Thức ăn': 'FOOD',
            'Phụ kiện': 'ACCE',
            'Đồ chơi': 'TOYS',
            'Vệ sinh': 'CARE',
            'Quần áo': 'CLTH',
            'Chuồng': 'CAGE',
            'Vận chuyển': 'TRAN'
        };

        function GetCategoryPrefix(category) {
            return categoryPrefixes[category] || 'PETS';
        }

        function LoadCategories() {
            const categories = categoryList;
            
            const categorySelect = document.getElementById('category');
            while(categorySelect.options.length > 1) {
                categorySelect.remove(1);
            }
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            return Promise.resolve(categories);
        }

        function LoadProductList() {
            return fetch('/products')
                .then(res => res.json())
                .then(products => {
                    productIdList = products.map(product => product.productId);
                    return productIdList;
                })
                .catch(error => {
                    console.error('Không thể lấy danh sách sản phẩm:', error);
                    return [];
                });
        }

        function AutoGenerateID(category) {
            if (!category)
                return '';

            const prefix = GetCategoryPrefix(category);

            if (!productIdList || !Array.isArray(productIdList) || productIdList.length === 0) {
                return prefix + '0001';
            }

            const categoryIds = productIdList.filter(id =>
                id && typeof id === 'string' && id.startsWith(prefix)
            );

            if (categoryIds.length === 0) {
                return prefix + '0001';
            }

            let maxNumber = 0;

            categoryIds.forEach(id => {
                const numberPart = id.substring(prefix.length);
                const num = parseInt(numberPart, 10);
                if (!isNaN(num) && num > maxNumber) {
                    maxNumber = num;
                }
            });

            const nextNumber = maxNumber + 1;
            const formattedNumber = nextNumber.toString().padStart(4, '0');

            return prefix + formattedNumber;
        }

        function DisplayImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-btn" data-name="${file.name}">×</button>
                `;
                imagePreviewContainer.appendChild(preview);

                preview.querySelector('.remove-btn').addEventListener('click', function () {
                    const fileName = this.getAttribute('data-name');
                    RemoveFile(fileName);
                    preview.remove();
                });
            }
            reader.readAsDataURL(file);
        }

        function RemoveFile(fileName) {
            const newFileList = new DataTransfer();

            Array.from(selectedFiles.files)
                .filter(file => file.name !== fileName)
                .forEach(file => newFileList.items.add(file));

            selectedFiles = newFileList;
            UpdateFileInput();
        }

        function UpdateFileInput() {
            imagesInput.files = selectedFiles.files;
        }

        const style = document.createElement('style');
        style.textContent = `
            .input-error {
                border-color: #d32f2f !important;
                background-color: #fff8f8 !important;
            }
        `;
        document.head.appendChild(style);

        document.getElementById('category').addEventListener('change', function () {
            const selectedCategory = this.value;
            if (selectedCategory) {
                productIdInput.value = AutoGenerateID(selectedCategory);
            }
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const requiredFields = {
                'productId': 'ID sản phẩm',
                'title': 'Tên sản phẩm',
                'price': 'Giá',
                'quantity': 'Số lượng',
                'brand': 'Thương hiệu',
                'origin': 'Xuất xứ',
                'category': 'Danh mục'
            };

            const missingFields = [];

            for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
                const fieldElement = document.getElementById(fieldId);
                if (!fieldElement.value.trim()) {
                    missingFields.push(fieldName);
                    fieldElement.classList.add('input-error');
                } else {
                    fieldElement.classList.remove('input-error');
                }
            }

            if (missingFields.length > 0) {
                alert('Vui lòng điền đầy đủ thông tin cho các trường: ' + missingFields.join(', '));
                return;
            }

            const productId = productIdInput.value.trim();
            const selectedCategory = document.getElementById('category').value;

            if (!selectedCategory) {
                alert('Vui lòng chọn danh mục sản phẩm');
                return;
            }

            const expectedPrefix = GetCategoryPrefix(selectedCategory);
            if (!productId.startsWith(expectedPrefix)) {
                alert('ID sản phẩm không hợp lệ cho danh mục này');
                return;
            }

            if (productIdList.includes(productId)) {
                alert('ID sản phẩm này đã tồn tại');
                return;
            }

            const formData = new FormData(form);

            const price = parseFloat(document.getElementById('price').value);
            const quantity = parseInt(document.getElementById('quantity').value);

            if (price <= 0) {
                alert('Giá sản phẩm phải lớn hơn 0');
                return;
            }

            if (quantity < 0) {
                alert('Số lượng sản phẩm không được âm');
                return;
            }

            fetch('/products', {
                method: 'POST',
                body: formData
            })
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => {
                            throw new Error(text);
                        });
                    }
                    return res.text();
                })
                .then(message => {
                    alert(message);
                    form.reset();
                    productIdInput.value = '';
                    LoadProductList();

                    imagePreviewContainer.innerHTML = '';
                    selectedFiles = new DataTransfer();
                })
                .catch(error => {
                    alert('Lỗi: ' + error.message);
                });
        });

        const allInputs = form.querySelectorAll('input, select, textarea');
        allInputs.forEach(input => {
            input.addEventListener('input', function () {
                if (this.value.trim()) {
                    this.classList.remove('input-error');
                }
            });
        });

        imagesInput.addEventListener('change', function () {
            if (this.files.length > 10) {
                alert('Bạn chỉ được chọn tối đa 10 hình ảnh');
                this.value = '';
                return;
            }

            if (this.files) {
                Array.from(this.files).forEach(file => {
                    if (selectedFiles.files.length < 10) {
                        selectedFiles.items.add(file);
                        DisplayImagePreview(file);
                    }
                });

                UpdateFileInput();

                if (this.files.length + selectedFiles.files.length - this.files.length > 10) {
                    alert('Chỉ được chọn tối đa 10 hình ảnh. Chỉ 10 ảnh đầu tiên được thêm vào.');
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            LoadCategories().then(() => {
                return LoadProductList();
            }).then(() => {
                const selectedCategory = document.getElementById('category').value;
                if (selectedCategory) {
                    productIdInput.value = AutoGenerateID(selectedCategory);
                }
            });
        });
    </script>
</body>

</html>